<!--  
  student_search_js.html
-->

<script>

document.getElementById("admin-view").style.visibility = "hidden";
document.getElementById("add-student").style.visibility = "hidden";
google.script.run.withSuccessHandler(hideAdminView).isAdmin();
google.script.run.withSuccessHandler(successHandler).getMyScriptUrl();

var all_student_records;
var scriptUrl;
var options = {
  enableColumnReorder: false,
  multiColumnSort: true,
  enableCellNavigation: true,
  autoExpandColumns: false,
  forceFitColumns: false,
  showFooterRow: false,
};

var grid;
          
var columns = [
  { id: 'uin',
    name: 'UIN', 
    field: 'uin', 
    sortable: true, 
    width: 120 
  },
  {
    id: 'name',
    name: 'Name',
    field: 'name',
    sortable: true,
    toolTip: 'Really Really Really Long Title',
    width: 220
  },
  {
    id: 'advisor',
    name: 'Advisor',
    field: 'advisor',
    sortable: true,
    width: 220
  },
  {
    id: 'start_semester',
    name: 'Start Semester',
    field: 'start_semester',
    sortable: true,
    width: 130
  },
  {
    id: 'prelim_date',
    name: 'Prelim Date',
    field: 'prelim_date',
    sortable: true,
    width: 100
  },
  {
    id: 'proposal_date',
    name: 'Proposal Date',
    field: 'proposal_date',
    sortable: true,
    width: 100
  },
  {
    id: 'final_defense_date',
    name: 'Final Defense Date',
    field: 'final_defense_date',
    sortable: true,
    width: 100
  },
  {
    id: 'this_year_faculty_rating',
    name: 'Faculty Rating of This Year',
    field: 'this_year_faculty_rating',
    sortable: true,
    width: 100
  },
  {
    id: 'this_year_admin_rating',
    name: 'Dept Rating of This Year',
    field: 'this_year_admin_rating',
    sortable: true,
    width: 100
  },
  {
    id: 'last_year_admin_rating',
    name: 'Dept Rating of Last Year',
    field: 'last_year_admin_rating',
    sortable: true,
    width: 100
  },
  {
    id: 'qual_exam',
    name: 'Qual Exam',
    field: 'qual_exam',
    sortable: true,
    width: 110
  },
  {
    id: 'degree_plan_submitted',
    name: 'Degree Plan Submitted',
    field: 'degree_plan_submitted',
    sortable: true,
    width: 150
  },
  {
    id: 'cv',
    name: 'CV',
    field: 'cv',
    sortable: true,
    formatter: linkFormatter,
    width: 110
  },
  {
    id: 'report',
    name: 'Student Report',
    field: 'report',
    sortable: true,
    formatter: linkFormatter,
    width: 110
  },
  {
    id: 'all_reviews',
    name: 'All Reviews',
    field: 'all_reviews',
    sortable: false,
    formatter: linkFormatter,
    width: 120
  },
  {
    id: 'add_review',
    name: 'Add Review',
    field: 'add_review',
    sortable: false,
    formatter: linkFormatter,
    width: 120  },
  {
    id: 'remove',
    name: 'Remove',
    field: 'remove',
    sortable: false,
    formatter: linkFormatter,
    width: 120  },
    
];


// called while body loaded in student_search.html
function onLoad() {
  // todo
}


function hideAdminView(result) {
  if (result == true) {
    document.getElementById("view-name").innerHTML = "Admin View";
    document.getElementById("admin-view").style.visibility = "visible";
    document.getElementById("add-student").style.visibility = "visible";
  }
}



function linkFormatter(row, cell, value, columnDef, dataContext) {
        return value;
}


function successHandler(urlString){
  scriptUrl = urlString;
  google.script.run.withSuccessHandler(onSuccess).getAllStudentRecords();
}


// assign html items with corresponding values, called every time when renewing table. 
function onSuccess(student_data) {

  all_student_records = student_data["student_records"];
  ratings = student_data["ratings"];
  documents = student_data["documents"];

  var data = [];
  var j = 0;

  for(var i = 0; i < all_student_records.length; i++) {
        
    //Checking if student is marked as current student
    if(all_student_records[i][8] != "1")
    {
      continue;
    }

    var this_student_data = (data[j++] = {});
    var this_student_uin = all_student_records[i][4];
    this_student_data["uin"] = this_student_uin;

    var this_student_records = all_student_records[i];
    this_student_data = setStudentProfileAttributes( this_student_data, this_student_records );

    var this_student_ratings = ratings[this_student_uin];
    this_student_data = setStudentRatingAttributes( this_student_data, this_student_ratings );

    var this_student_documents = documents[this_student_uin];
    this_student_data = setStudentDocumentAttributes( this_student_data, this_student_documents );

    this_student_data = setStudentLinkAttributes( this_student_data, this_student_uin );
  }
    
  grid = new Slick.Grid( '#myGrid', data, columns, options );
  grid.registerPlugin( new Slick.AutoTooltips( {enableForHeaderCells: true} ) );

  grid.onSort.subscribe( function(e, args) 
  {
    var cols = args.sortCols;
    data.sort( function(dataRow1, dataRow2)
    {
      for (var i = 0, l = cols.length; i < l; i++) 
      {
        var field = cols[i].sortCol.field;
        var sign = cols[i].sortAsc ? 1 : -1;
        var value1 = dataRow1[field];
        var value2 = dataRow2[field];
        var result = (value1 == value2 ? 0 : value1 > value2 ? 1 : -1) * sign;
        if (result != 0) 
        {
          return result;
        }
      }
      return 0;
    });

    grid.invalidate();
    grid.render();
      
  });


  return;
}


// fill table elements with student data
function setStudentProfileAttributes( this_student_data, this_student_records )
{
  this_student_data["name"] = this_student_records[3] + ', ' + this_student_records[2];
  this_student_data["advisor"] = this_student_records[9];
  this_student_data["start_semester"] = this_student_records[6];
  this_student_data["prelim_date"] = this_student_records[15];
  this_student_data["proposal_date"] = this_student_records[16];
  this_student_data["final_defense_date"] = this_student_records[17];
  this_student_data["qual_exam"] = this_student_records[12];
  this_student_data["degree_plan_submitted"] = this_student_records[11];

  return this_student_data;
}


// fill table elements with student ratings
function setStudentRatingAttributes( this_student_data, this_student_ratings )
{
  this_student_data["this_year_faculty_rating"] = "-";
  this_student_data["this_year_admin_rating"] = "-";
  this_student_data["last_year_admin_rating"] = "-";

  if(!this_student_ratings)
  {
    return this_student_data;
  }
  if( this_student_ratings["admin_this_year"] != "" )
  {
    this_student_data["this_year_admin_rating"] = this_student_ratings["admin_this_year"];
  }
  if( this_student_ratings["admin_last_year"] != "" )
  {
    this_student_data["last_year_admin_rating"] = this_student_ratings["admin_last_year"];
  }
  if( this_student_ratings["faculty_this_year"] != "" )
  {
    this_student_data["this_year_faculty_rating"] = this_student_ratings["faculty_this_year"];
  }
  
  return this_student_data;
}


// fill table elements with document (CV, report) links
function setStudentDocumentAttributes( this_student_data, this_student_documents )
{
  this_student_data["cv"] = "-";
  this_student_data["report"] = "-";

  if( !this_student_documents )
  {
    return this_student_data;
  }
  if(this_student_documents["cv"] != "") 
  {
    this_student_data["cv"] = "<a href=" + this_student_documents["cv"] + " target = \"_blank\"><u>CV</u></a>";
  }
  if(this_student_documents["report"] != "") 
  {
    this_student_data["report"] = "<a href=" + this_student_documents["report"] + " target = \"_blank\"><u>Reports</u></a>";
  }

  return this_student_data;
}


// fill table elements with links to pages (reviews, add-review, remove)
function setStudentLinkAttributes( this_student_data, this_student_uin )
{
  var review_link = "'" + scriptUrl + "?v=see_reviews&uin=" + this_student_uin +"'";
  this_student_data["all_reviews"] = "<a href=" + review_link + " target = \"_blank\"><u>Reviews</u></a>";

  var add_review_link = "'" + scriptUrl + "?v=add_review&uin=" + this_student_uin +"'";
  this_student_data["add_review"] = "<a href=" + add_review_link + " target = \"_blank\"><u>Add Review</u></a>";

  var remove_link = "'" + scriptUrl + "?v=remove_student&uin=" + this_student_uin +"'";
  this_student_data["remove"] = "<a href=" + remove_link + " target = \"_blank\"><u>Remove</u></a>";

  return this_student_data;
}


// called when search button clicked
function searchBtnClicked(){

  console.log("search button clicked");
  var filter = {}
    
  var first_name = document.getElementById("first_name").value;
  if(first_name.length > 0){
    filter.first_name = first_name;
  }
    
  var last_name = document.getElementById("last_name").value;
  if(last_name.length > 0){
     filter.last_name = last_name;
  }
    
  var uin = document.getElementById("uin").value;
  if(uin.length > 0){
    filter.uin = uin;
  }
    
  google.script.run.withSuccessHandler(onSuccess).getFilteredStudentRecords(filter);
}

</script>
