<!--  
  add_student_review_js.html
-->


<script>

var doc_type_name = { "cv_url" : "CV", "report_url" : "REPORT", "improvement_plan_url" : "IMPROVEMENT PLAN", "department_letter_url" : "DEPARTMENT LETTER" };

M.FormSelect.init(reviewSelect);

var adminMode = false;
document.getElementById("adminOnlyNotes").style.display = 'none';
document.getElementById("adminOnlyCheckboxes").style.display = 'none';
document.getElementById("admin-view").style.visibility = "hidden";
document.getElementById("add-student").style.visibility = "hidden";
document.getElementById("dl").style.visibility = "hidden";
document.getElementById("dl_wrapper").style.visibility = "hidden";

google.script.run.withSuccessHandler(setAttributesToAdminView).isAdmin();

// if user is admin, set corresponding html attributes
function setAttributesToAdminView(result) 
{
  if (result == true) 
  {
    document.getElementById("admin-view").style.visibility = "visible";
    document.getElementById("add-student").style.visibility = "visible";
    document.getElementById("dl").style.visibility = "visible";
    document.getElementById("dl_wrapper").style.visibility = "visible";
    adminMode = true;
    document.getElementById("adminOnlyNotes").style.display = 'inline';
    document.getElementById("adminOnlyCheckboxes").style.display = 'inline';
    document.getElementById("view-name").innerHTML = "Admin View";
  }
}


// trgger while page onload
function onLoad() {
  google.script.run.withSuccessHandler(populateReviewYearsDropdown).getAllReviewYears();
  onChangeReviewYear();
}


// populate review_year deopdown list by all available review years
function populateReviewYearsDropdown(all_review_years){
  
  var review_year_dropdown = document.getElementById("review_year");
  var i;
  for (i = 0; i < all_review_years.length; i++) {
    var review_year_option = document.createElement("OPTION");
    review_year_option.text = all_review_years[i];
    review_year_option.value = all_review_years[i];
    review_year_dropdown.options.add(review_year_option);
  }
  M.FormSelect.init(review_year_dropdown);
  return;
}


// trigger while review year changed
function onChangeReviewYear() {

    var uin = document.getElementById("uinForThisPage").innerHTML;
    var reviewYear = document.getElementById("review_year").value;
    
    google.script.run.withSuccessHandler(onSuccessToGetStudentReviewInformation).getReviewInformationFromUinAndYear(uin, reviewYear);
}


// map html attributes with received data 
function onSuccessToGetStudentReviewInformation(result) {

    console.log("student review info:" + result);

    document.getElementById("commentsForStudent").value = result[9];
    textAreaAdjust(document.getElementById("commentsForStudent")); // adjust textarea height to fit content
    document.getElementById("commentsForFaculty").value = result[10];
    textAreaAdjust(document.getElementById("commentsForFaculty")); // adjust textarea height to fit content
    document.getElementById("reviewSelect").value = result[4];
    document.getElementById("needsToImproveGrade").checked = result[11] == 1 ? true : false;
    document.getElementById("noStudentReportAvailable").checked = result[12] == 1 ? true : false;
    document.getElementById("misconduct").checked = result[13] == 1 ? true : false;
    document.getElementById("needsToPassQualiferExam").checked = result[14] == 1 ? true : false;
    document.getElementById("needsToFindAdvisor").checked = result[15] == 1 ? true : false;
    document.getElementById("needsToFileDegreePlan").checked = result[16] == 1 ? true : false;
    document.getElementById("needsToDoPrelim").checked = result[17] == 1 ? true : false;
    document.getElementById("needsToSubmitProposal").checked = result[18] == 1 ? true : false;
    document.getElementById("needsToFinishSoon").checked = result[19] == 1 ? true : false;
    
    
    //Code for fetching Student Report and IP links
    var uin = document.getElementById("uinForThisPage").innerHTML;
    var review_year = document.getElementById("review_year").value;
    console.log("Selected year: ", review_year, " , selected uin: ", uin );
    google.script.run.withSuccessHandler(setDocUrlsAttribute).getStudentDocumentUrls( uin, review_year );    
}


// set hyperlink attributes for student report, improvement plan & dept. letter
function setDocUrlsAttribute( document_urls ){

  console.log("in function setDocUrlsAttribute");
  
  setUrlAttribute( document_urls.report, 'report_url' );
  setUrlAttribute( document_urls.improvement, 'improvement_plan_url' );
  setUrlAttribute( document_urls.departmentletter, 'department_letter_url' );
  return;
}

function check_ip(){
  var b = document.getElementById('viewImprovementPlan');
  if( b.getAttribute("href") == "" ){
    alert("Improvement Plan not uploaded for this review year");
    return false;
  }
  return true;
}

function check_re(){
  var b = document.getElementById('viewStudentReport');
  if(b.getAttribute("href")==""){
    alert("Report not uploaded for this review year");
    return false;
  }
  return true;
}

function check_dl(){
  var b = document.getElementById('viewDepartmentLetter');
  if(b.getAttribute("href")==""){
    alert("Department Letter is not available");
    return false;
  }
  return true;
}


// trigger when reviewSubmitButton clicked
function onSubmitClicked()
{
  //console.log("submit clicked")
  
  // upload Departmental Letter
  var uin = document.getElementById("uinForThisPage").innerHTML;
  var fullName = document.getElementById("fname").innerHTML+" "+document.getElementById("lname").innerHTML;
   
  var studentReviewDetails = {};
    
  var selectReviewYearElement = document.getElementById("review_year");
  var reviewYear = selectReviewYearElement.options[selectReviewYearElement.selectedIndex].value;
    
  var selectReviewElement = document.getElementById("reviewSelect");
  var rating = selectReviewElement.options[selectReviewElement.selectedIndex].value;
    
  var commentsForStudents = document.getElementById("commentsForStudent").value;
  var commentsForFaculty = document.getElementById("commentsForFaculty").value;
    
  var needsToImproveGrade = !adminMode ? 0 : (document.getElementById("needsToImproveGrade").checked == true ? 1 : 0);
  var noStudentReportAvailable = !adminMode ? 0 : (document.getElementById("noStudentReportAvailable").checked == true ? 1 : 0);
  var misconduct = !adminMode ? 0 : (document.getElementById("misconduct").checked == true ? 1 : 0);
  var needsToPassQualiferExam = !adminMode ? 0 : (document.getElementById("needsToPassQualiferExam").checked == true ? 1 : 0);
  var needsToFindAdvisor = !adminMode ? 0 : (document.getElementById("needsToFindAdvisor").checked == true ? 1 : 0);
  var needsToFileDegreePlan = !adminMode ? 0 : (document.getElementById("needsToFileDegreePlan").checked == true ? 1 : 0);
  var needsToDoPrelim = !adminMode ? 0 : (document.getElementById("needsToDoPrelim").checked == true ? 1 : 0);
  var needsToSubmitProposal = !adminMode ? 0 : (document.getElementById("needsToSubmitProposal").checked == true ? 1 : 0);
  var needsToFinishSoon = !adminMode ? 0 : (document.getElementById("needsToFinishSoon").checked == true ? 1 : 0);
        
  studentReviewDetails.uin = uin;
  studentReviewDetails.facultyName = "";
  studentReviewDetails.reviewYear = reviewYear;
  studentReviewDetails.rating = rating;
  studentReviewDetails.commentsForStudents = commentsForStudents;
  studentReviewDetails.commentsForFaculty = commentsForFaculty;
  studentReviewDetails.needsToImproveGrade = needsToImproveGrade;
  studentReviewDetails.noStudentReportAvailable = noStudentReportAvailable;
  studentReviewDetails.misconduct = misconduct;
  studentReviewDetails.needsToPassQualiferExam = needsToPassQualiferExam;
  studentReviewDetails.needsToFindAdvisor = needsToFindAdvisor;
  studentReviewDetails.needsToFileDegreePlan = needsToFileDegreePlan;
  studentReviewDetails.needsToDoPrelim = needsToDoPrelim;
  studentReviewDetails.needsToSubmitProposal = needsToSubmitProposal;
  studentReviewDetails.needsToFinishSoon = needsToFinishSoon;
  studentReviewDetails.reportUrl = document.getElementById("report_url").getAttribute("href");
  studentReviewDetails.improvementPlanUrl = document.getElementById("improvement_plan_url").getAttribute("href");
  
  // upload Department Letter
  var dl = document.getElementById("dl").files[0];
  if (dl)
  {  
    document.getElementById('dl_wrapper').value = ""; // clear file-path-wrapper once uploaded
    var dlURL = document.getElementById('department_letter_url');
    dlURL.setAttribute("disabled", "disabled"); // disable cv_url
    dlURL.removeAttribute("href");
    dlURL.innerText = "UPLOADING DEPARTMENT LETTER...";

    //uploadDocument( dl, "dl", reviewYear);
    uploadFile(dl,"dl",reviewYear,fullName,uin);

  }
    
  console.log("Student", studentReviewDetails.reportUrl);
  console.log("calling update review details function");

  
  google.script.run.withFailureHandler(onFailureOfReviewSubmit)
    .withSuccessHandler(onSuccessOfReviewSubmit)
    .updateStudentReviewDetails(studentReviewDetails);
  return;
  
}


function uploadFile(f,file_type,year,fullName,uin) {
  
  var file, reader = new FileReader();
  reader.onloadend = function(e) {
    google.script.run.withSuccessHandler(reset_fields)
    .uploadDLToDrive(
    e.target.result, file.name,
    file_type,year,fullName,uin
    );
  };

  file = f;
  if(file){  
    reader.readAsDataURL(file);
  }
  
}


function reset_fields()
{
  console.log("Inside reset fields");
  var a = document.getElementById("dl");
  a.value = "";
  document.getElementById('dl_wrapper').value = "";
  var selectReviewYearElement = document.getElementById("review_year");
  var year = selectReviewYearElement.options[selectReviewYearElement.selectedIndex].value;
  google.script.run.withSuccessHandler(setDocUrlsAttribute).getStudentDocumentUrls(document.getElementById("uinForThisPage").innerHTML,year);
  return;
}


function onSuccessOfReviewSubmit(result) 
{
    alert("Review saved successfully!");
    return;
}


// alert when student review not being submitted successfully
function onFailureOfReviewSubmit(result) 
{
    alert("Failed to save review.");
    return;
}


// auto-adjust text area height to fit content
function textAreaAdjust(o) 
{
  o.style.height = "1px";
  o.style.height = (o.scrollHeight)+"px";
  return;
}




// make hyperlink show innerText according to its file status 
function setUrlAttribute( doc_url, id ) {

  var cvURL = document.getElementById( id );
  var this_type_name = doc_type_name[ id ]

  // if cv found in userInfo
  if ( doc_url != "" ){

    // set inner text to file name
    google.script.run.withSuccessHandler( function(fileName) {
      cvURL.innerText = fileName;
    }).getFileNameFromURL(doc_url);

    cvURL.href = doc_url;
    cvURL.removeAttribute("disabled"); // enable cv_url 
  }
  else { // if cv not found in userInfo

    cvURL.setAttribute("disabled", "disabled"); // disable cv_url

    // if the previous state of cv_url inner text is not "uploading CV..." and cv not found,
    // it means cv not exist in database.
    console.log( cvURL.innerText );
    
    if ( cvURL.innerText != "UPLOADING " + this_type_name + "..." ) {
      cvURL.innerText = this_type_name + " NOT UPLOADED";
    } 

    cvURL.href = "";
  }
  return;
}
  
</script>
