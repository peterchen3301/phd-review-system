<script>

  function resetProfileFields() {  
     google.script.run.withSuccessHandler(onSuccess).getProfileInformation();
  }
  

  function discardClicked(){
    window.location.reload(false);
    return true;
  }
  

  function updateClicked(){

    var userInfo = {};

    userInfo.firstname = document.getElementById("fn").value;
    userInfo.lastname = document.getElementById("ln").value;
    userInfo.UIN = document.getElementById("uin_").value;
    userInfo.email = document.getElementById("email").value;
    userInfo.startsem = document.getElementById("start-semester").value;
    userInfo.qualstatus = document.getElementById("qual").value;
    userInfo.advisor = document.getElementById("advisor").value;
    userInfo.coadvisor = document.getElementById("co-advisor").value;
    userInfo.degreeplanstatus = document.getElementById("degree-plan").value;
    
    var a = document.getElementById("prelim-date").value;
    if (a!=""){
      userInfo.prelime_date  =  (document.getElementById("prelim-date").value);
    }else{
      userInfo.prelime_date  = a;
    }
    
    var b = document.getElementById("proposal-date").value;
    if (b!=""){
      userInfo.proposal_date  =  document.getElementById("proposal-date").value;
    }else{
      userInfo.proposal_date  = b;
    }
    
    var c = document.getElementById("defense-date").value;
    if (c!=""){
      userInfo.defense_date = document.getElementById("defense-date").value;
    }else{
      userInfo.defense_date  = c;
    }
    
    google.script.run.submitProfileToStudentInfo(userInfo);
  
    var cv = document.getElementById("cv").files[0];

    console.log( "cv: ", cv );

    // if CV exist in the file field
    if (cv) {
      console.log("CV uploading...");
      document.getElementById('filename').value = ""; // clear file-path-wrapper once uploaded
      var cvURL = document.getElementById('cv_url');
      cvURL.setAttribute("disabled", "disabled"); // disable cv_url
      cvURL.removeAttribute("href");
      cvURL.innerText = "UPLOADING CV..."
      uploadFile(userInfo,cv,"cv");
    }

    alert("Data Updated");
    return;
  }

  
  function uploadFile( userInfo, f, file_type ) {

    var file, reader = new FileReader();
    var fullName = userInfo.firstname + " " + userInfo.lastname;

    reader.onloadend = function(e) {
      google.script.run.withSuccessHandler(resetProfileFields).uploadFileToDrive(
        e.target.result, 
        file.name,
        fullName,
        file_type,
        userInfo.email
      );
    };
    
    file = f;
    if(file){  
      reader.readAsDataURL(file);
    } 
}
  

function onSuccess(userInfo) {
    
  console.log("User Info returned ");
  console.log(userInfo);
   
  document.getElementById("fn").value = userInfo.firstname;
  document.getElementById("ln").value = userInfo.lastname;
  document.getElementById("uin_").value = userInfo.UIN;
  document.getElementById("email").value = userInfo.email;
       /////// For Drop Down//////////
      
  var a  = document.getElementById("start-semester");
  a.value = userInfo.startsem;
  M.FormSelect.init(a);
  
  var a  = document.getElementById("qual");
  a.value = userInfo.qualstatus;
  M.FormSelect.init(a);
    
  /*
  var a  = document.getElementById("attempts");
  a.value = userInfo.numattempts;
  M.FormSelect.init(a);
  */

  var a  = document.getElementById("advisor");
  a.value = userInfo.advisor;
  M.FormSelect.init(a);
    
  var a  = document.getElementById("co-advisor");
  a.value = userInfo.coadvisor;
  M.FormSelect.init(a);
    
  var a  = document.getElementById("degree-plan");
  a.value = userInfo.degreeplanstatus;
  M.FormSelect.init(a);
    
    
  //////////////////////////////////////
  var elem  = document.getElementById("prelim-date");

  var options = {
          defaultDate: new Date(userInfo.prelime_date),
          setDefaultDate: true,
          format: "mm/dd/yyyy"
      };
  var instance = M.Datepicker.init(elem, options);
    
    
  var elem  = document.getElementById("proposal-date");

  var options = {
          defaultDate: new Date(userInfo.proposal_date),
          setDefaultDate: true,
          format: "mm/dd/yyyy"
      };
  var instance = M.Datepicker.init(elem, options);
    
    
var elem  = document.getElementById("defense-date");

  var options = {
      defaultDate: new Date(userInfo.defense_date),
      setDefaultDate: true,
      format: "mm/dd/yyyy"
    };
  var instance = M.Datepicker.init(elem, options);
    
  setCVUrlAttribute( userInfo );
    
  google.script.run.withSuccessHandler(function(activeYear) {    
    if(activeYear == "None") {

      console.log(activeYear);
      $('input').attr('disabled', true);

      document.getElementById('update').disabled = true;
      document.getElementById('discard').disabled = true;
      document.getElementById('filename').disabled = true;
      document.getElementById('up').classList.remove("btn") ;

      alert(" No Active Review Year");
    
    }
  }).getActiveReviewYear();
    
  M.updateTextFields();
}


function check_cv(){

  var cv_link = document.getElementById('cv_url');
  console.log("In here");
  console.log('b: ',cv_link.href);
  
  if(cv_link.href==""){
    alert("CV not Uploaded");
  }
}


// set attribute of cv_url hyperlink according to input url
function setCVUrlAttribute( userInfo ) {

  var cvURL = document.getElementById("cv_url");

  // if cv found in userInfo
  if ( userInfo.cv_url != "" ){

    // set inner text to file name
    google.script.run.withSuccessHandler( function(fileName) {
      cvURL.innerText = fileName;
    }).getFileNameFromURL(userInfo.cv_url);

    cvURL.href = userInfo.cv_url;
    cvURL.removeAttribute("disabled"); // enable cv_url 

    console.log("CV found in database: ", cvURL.href);
  }
  else { // if cv not found in userInfo

    cvURL.setAttribute("disabled", "disabled"); // disable cv_url

    // if the previous state of cv_url inner text is not "uploading CV..." and cv not found,
    // it means cv not exist in database.
    console.log( cvURL.innerText );
    
    if ( cvURL.innerText != "UPLOADING CV..." ) {
      cvURL.innerText = "CV NOT UPLOADED";
    } 

    cvURL.href = "";
    console.log("CV not found.");
  }

    return;
}

</script>
