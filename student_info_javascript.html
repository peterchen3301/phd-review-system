<!--  
  student_info_javascript.html
  
-->

<script>

  var doc_type_name = { "cv_url" : "CV", "report_url" : "REPORT", "improvement_plan_url" : "IMPROVEMENT PLAN", "department_letter_url" : "DEPARTMENT LETTER" };


  // get current user's (student) info, called every time we renew the page.
  function resetProfileFields() 
  { 
    google.script.run.withSuccessHandler(onSuccess).getProfileAndReviewByYear();
  }


  // assign html items with corresponding values, called every time when renewing student profle. 
  function onSuccess( user_data ) {

    setCurrentReviewYearAttribute();

    user_info = user_data['student_info'];
    setUserInfoAttribute( user_info );

    doc_urls = user_data['doc_urls'];
    setDocUrlsAttribute( doc_urls );

    review_comments = user_data['review_comments'];
    setReviewCommentAttribute( review_comments );
      
    M.updateTextFields();
    return;
  }


  // called when discard button clicked, remove input elements
  function discardClicked()
  {
    resetFileInputs();
    return;
  }


  // reset input fields and wrappers of CV, Report and Improvement Plan 
  function resetFileInputs()
  {
    document.getElementById("cv").value = '';
    document.getElementById("cv_wrapper").value = '';

    document.getElementById("report").value = '';
    document.getElementById("report_wrapper").value = '';

    document.getElementById("improvement").value = '';
    document.getElementById("improvement_plan_wrapper").value = '';

    return;
  }


  // called when update button clicked
  function updateClicked(){

    // no need to upload profile since they are set read-only from student view
    // and thus cannot be edited
    //uploadProfileToStudentInfo();

    var current_review_year = document.getElementById("review_year_title").value;

    var cv = document.getElementById("cv").files[0];
    var report = document.getElementById("report").files[0];
    var improvement = document.getElementById("improvement").files[0];

    // upload CV
    if (cv) { // if CV to be uploaded
      console.log("CV uploading...");
      document.getElementById('cv_wrapper').value = ""; // clear file-path-wrapper once uploaded
      var cvURL = document.getElementById('cv_url');
      cvURL.setAttribute("disabled", "disabled"); // disable cv_url
      cvURL.removeAttribute("href");
      cvURL.innerText = "UPLOADING CV..."
      uploadDocument( cv, "cv", current_review_year);
    }

    // upload report
    if (report) { // if report to be uploaded
      console.log("Report uploading...");
      document.getElementById('report_wrapper').value = ""; // clear file-path-wrapper once uploaded
      var reportURL = document.getElementById('report_url');
      reportURL.setAttribute("disabled", "disabled"); // disable cv_url
      reportURL.removeAttribute("href");
      reportURL.innerText = "UPLOADING REPORT..."
      uploadDocument( report, "re", current_review_year );
    }

    // upload improvement plan
    if (improvement) { // if improvement plan to be uploaded
      console.log("Improvement plan uploading...");
      document.getElementById('improvement_plan_wrapper').value = ""; // clear file-path-wrapper once uploaded
      var improvementURL = document.getElementById('improvement_plan_url');
      improvementURL.setAttribute("disabled", "disabled"); // disable cv_url
      improvementURL.removeAttribute("href");
      improvementURL.innerText = "UPLOADING IMPROVEMENT LETTER..."
      uploadDocument( improvement, "ip", current_review_year );
    }

    resetFileInputs();

    alert("Updating Data");
    return;
  }
  

  // upload personal profile to student_info_sheet
  function uploadProfileToStudentInfo()
  {
    var userInfo = {};

    userInfo.firstname = document.getElementById("fn").value;
    userInfo.lastname = document.getElementById("ln").value;
    userInfo.UIN = document.getElementById("uin_").value;
    userInfo.email = document.getElementById("email").value;
    userInfo.startsem = document.getElementById("start-semester").value;
    userInfo.qualstatus = document.getElementById("qual").value;
    userInfo.advisor = document.getElementById("advisor").value;
    userInfo.coadvisor = document.getElementById("co-advisor").value;
    userInfo.degreeplanstatus = document.getElementById("degree-plan").value;
    
    var a = document.getElementById("prelim-date").value;
    if (a!=""){
      userInfo.prelime_date  =  (document.getElementById("prelim-date").value);
    }else{
      userInfo.prelime_date  = a;
    }
    
    var b = document.getElementById("proposal-date").value;
    if (b!=""){
      userInfo.proposal_date  =  document.getElementById("proposal-date").value;
    }else{
      userInfo.proposal_date  = b;
    }
    
    var c = document.getElementById("defense-date").value;
    if (c!=""){
      userInfo.defense_date = document.getElementById("defense-date").value;
    }else{
      userInfo.defense_date  = c;
    }
    
    google.script.run.submitProfileToStudentInfo(userInfo);

    return
  }

  
  // upload CV file to GoogleDrive and update url to student_info_sheet : not useful
  function uploadCVFile( userInfo, f, file_type ) {

    var file, reader = new FileReader();
    var fullName = userInfo.firstname + " " + userInfo.lastname;

    reader.onloadend = function(e) {
      google.script.run.withSuccessHandler(resetProfileFields).uploadFileToDrive(
        e.target.result, 
        file.name,
        fullName,
        file_type,
        userInfo.email
      );
    };
    
    file = f;
    if(file){  
      reader.readAsDataURL(file);
    } 

    return;
}


// upload documents ( improvement_plan, report ) to GoogleDrive and update url to student_review_sheet
function uploadDocument( f, file_type, year ) {

  var file, reader = new FileReader();
  
  reader.onloadend = function(e) {
    google.script.run.withSuccessHandler(resetProfileFields).uploadIp_R_ToDrive(
    e.target.result, 
    file.name,
    file_type,
    year
    );
  };

  file = f;
  if(file){  
    reader.readAsDataURL(file);
  }
  return;
}


// get current review year and set as title
function setCurrentReviewYearAttribute() {

  google.script.run.withSuccessHandler(function(activeYear) {    

    if(activeYear == "None") {
      console.log(activeYear);
      $('input').attr('disabled', true);
      document.getElementById('update').disabled = true;
      document.getElementById('discard').disabled = true;
      document.getElementById('cv_wrapper').disabled = true;
      document.getElementById('report_wrapper').disabled = true;
      document.getElementById('improvement_plan_wrapper').disabled = true;
      document.getElementById('up').classList.remove("btn") ;
      alert(" No Active Review Year");
    }
    else {
      document.getElementById("review_year_title").value = activeYear;
      document.getElementById("review_year_title").innerText = 'Review Year : ' + activeYear.toString();
    }

  }).getActiveReviewYear();

  return;
}


// set up review comments textarea
function setReviewCommentAttribute( review_comments ) {

  if (review_comments['comments_for_student'] != ""){
    var a = document.getElementById("comments_for_student");
    a.value = review_comments['comments_for_student'];
    M.textareaAutoResize($('#comments_for_student'));
  }
  else{
    document.getElementById("comments_for_student").value = " No Reviews Available Now";
  }

  return;
}

// set up student_report, impprovement_letter and department_letter hyperlink
function setDocUrlsAttribute( document_urls ) {

  setUrlAttribute( document_urls.cv, 'cv_url' );
  
  setUrlAttribute( document_urls.report, 'report_url' );

  setUrlAttribute( document_urls.improvement, 'improvement_plan_url' );

  setUrlAttribute( document_urls.departmentletter, 'department_letter_url' );


  return;
}


// set up user-info items
function setUserInfoAttribute( userInfo ) {
  
  document.getElementById("fn").value = userInfo.firstname;
  document.getElementById("ln").value = userInfo.lastname;
  document.getElementById("uin_").value = userInfo.UIN;
  document.getElementById("email").value = userInfo.email;
       /////// For Drop Down//////////
      
  var a  = document.getElementById("start-semester");
  a.value = userInfo.startsem;
  M.FormSelect.init(a);
  
  var a  = document.getElementById("qual");
  a.value = userInfo.qualstatus;
  M.FormSelect.init(a);
    
  /*
  var a  = document.getElementById("attempts");
  a.value = userInfo.numattempts;
  M.FormSelect.init(a);
  */

  var a  = document.getElementById("advisor");
  a.value = userInfo.advisor;
  M.FormSelect.init(a);
    
  var a  = document.getElementById("co-advisor");
  a.value = userInfo.coadvisor;
  M.FormSelect.init(a);
    
  var a  = document.getElementById("degree-plan");
  a.value = userInfo.degreeplanstatus;
  M.FormSelect.init(a);
    

  var elem  = document.getElementById("prelim-date");
  var options = {
          defaultDate: new Date(userInfo.prelime_date),
          setDefaultDate: true,
          format: "mm/dd/yyyy"
      };
  var instance = M.Datepicker.init(elem, options);
    
    
  var elem  = document.getElementById("proposal-date");
  var options = {
          defaultDate: new Date(userInfo.proposal_date),
          setDefaultDate: true,
          format: "mm/dd/yyyy"
      };
  var instance = M.Datepicker.init(elem, options);
    
    
  var elem  = document.getElementById("defense-date");
  var options = {
      defaultDate: new Date(userInfo.defense_date),
      setDefaultDate: true,
      format: "mm/dd/yyyy"
    };
  var instance = M.Datepicker.init(elem, options);
  
  return;
}


// make hyperlink show innerText according to its file status 
function setUrlAttribute( doc_url, id ) {

  var cvURL = document.getElementById( id );
  var this_type_name = doc_type_name[ id ]

  // if cv found in userInfo
  if ( doc_url != "" ){

    // set inner text to file name
    google.script.run.withSuccessHandler( function(fileName) {
      cvURL.innerText = fileName;
    }).getFileNameFromURL(doc_url);

    cvURL.href = doc_url;
    cvURL.removeAttribute("disabled"); // enable cv_url 
  }
  else { // if cv not found in userInfo

    cvURL.setAttribute("disabled", "disabled"); // disable cv_url

    // if the previous state of cv_url inner text is not "uploading CV..." and cv not found,
    // it means cv not exist in database.
    console.log( cvURL.innerText );
    
    if ( cvURL.innerText != "UPLOADING " + this_type_name + "..." ) {
      cvURL.innerText = this_type_name + " NOT UPLOADED";
    } 

    cvURL.href = "";
  }
  return;
}

</script>
